var utilJS = require('../../public/util')
var config = require('../../public/config')
const superagent = require('superagent')
require('superagent-proxy')(superagent)
var cheerio = require('cheerio')
var fs = require('fs')
require('superagent-charset')(superagent)
var dateTime = require('date-time')
var startOn = dateTime()
var postUrl = ''
var postErrorUrl = ''
process.env.NODE_TLS_REJECT_UNAUTHORIZED = 0;
if (config.env == 'dev') {
  postUrl = config.dev.post_result_url
    postErrorUrl = config.dev.post_error_url
} else {
    postUrl = config.pro.post_result_url
    postErrorUrl = config.pro.post_error_url
}

var arguments = process.argv.splice(2);

var taskRunLogId = arguments[0]

if (taskRunLogId == undefined) {
    taskRunLogId = 0
}

var charset = '""'

if (charset.length == 2) {
    charset = ''
}

crawlList('https://bhex.zendesk.com/hc/zh-cn/categories/360000882773-%E5%85%AC%E5%91%8A%E4%B8%AD%E5%BF%83')


var date = startOn.split(' ')[0]

function crawlList(listUrl) {
    var header = {}

    superagent
        .get(listUrl)
        .set(header)

        .charset(charset)
        .timeout({deadline:60000})
        .end((err, res) => {
            if (err) {
                var content = ''
                if (err.code) {
                    content = '网站连接失败,错误码:' + err.code + ', 错误信息: ' + err.errno + '!'
                } else if (typeof err.response.res !=="undefined") {
                    //错误
                    content = '网站请求错误,错误码:'+ err.response.res.statusCode + ', 错误信息: ' + err.response.res.statusMessage + '!'
                }
                postError(content)
            } else {

                $ = cheerio.load(res.text)

                var indexNews = []

                $('.article-list .li').each(function(){

                    var seleteItem = {}

                    var title = $(this).find(".article-list-link a").text()
                    var description = ""
                    var showTime = ""
                    var detailUrl = "https://bhex.zendesk.com" + $(this).find(".article-list-link a").attr("href")
                    var content = ""
                        console.log(title)
                        seleteItem['title'] = title
                    seleteItem['description'] = description
                    seleteItem['show_time'] = showTime
                    seleteItem['detail_url'] = detailUrl
                    seleteItem['content'] = content

                    indexNews.push(seleteItem);
                })

                postListData(indexNews)
            }
        })
}

function postListData(data) {
     var responseData = {
        company: '财富',
        content_type: '1',
        task_run_log_id: taskRunLogId,
        start_time: startOn,
        end_time: dateTime(),
        result: data
    }

    superagent
        .post(postUrl)
        .send(responseData)
        .timeout({deadline:10000})
        .end((err, res) => {
            if (err) {
                console.log("[ERROR] list " + JSON.stringify(responseData))
                console.log(err.response.text)
            } else {
                console.log(res.text)
            }
        });
}

function postError(content) {
     var errorData = {
        content: content,
        task_run_log_id: taskRunLogId
    }

    superagent
        .post(postErrorUrl)
        .send(errorData)
        .timeout({deadline:10000})
        .end((err, res) => {
            if (err) {
                console.log("[ERROR] list " + JSON.stringify(errorData))
                console.log(err.response.text)
            } else {
                console.log(res.text)
            }
        })
}
fs.appendFile(config.project_path + '/logs/script-' + date + '.log', '财富列表脚本已执行,task_run_log_id = ' + taskRunLogId + ',完成时间: ' + dateTime() + '\r\n', (err) => {
  if (err) throw err;
})
